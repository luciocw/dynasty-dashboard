<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynasty Dashboard - Sleeper</title>
    <meta name="description" content="Visualize todas suas ligas Sleeper de Fantasy Football em um s√≥ lugar">
    <meta name="theme-color" content="#0f1419">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèà</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f26;
            --bg-card: #242a33;
            --bg-hover: #2d353f;
            --text-primary: #e7e9ea;
            --text-secondary: #8b98a5;
            --accent: #1d9bf0;
            --accent-hover: #1a8cd8;
            --success: #00ba7c;
            --warning: #ffad1f;
            --error: #f4212e;
            --dynasty: #8b5cf6;
            --redraft: #10b981;
            --keeper: #f59e0b;
            --border: #2f3640;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--bg-secondary);
            padding: 0.5rem 1rem;
            border-radius: 9999px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent);
        }

        .user-name {
            font-weight: 600;
        }

        .logout-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            border-color: var(--error);
            color: var(--error);
        }

        /* Search Section */
        .search-section {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 2.5rem 2rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .search-logo {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .search-title {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .search-subtitle {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }

        .search-form {
            display: flex;
            gap: 0.75rem;
            max-width: 500px;
            margin: 0 auto;
        }

        .search-input {
            flex: 1;
            padding: 0.875rem 1.25rem;
            border: 2px solid var(--border);
            border-radius: 9999px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .search-input::placeholder {
            color: var(--text-secondary);
        }

        .search-btn {
            padding: 0.875rem 2rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 9999px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-btn:hover {
            background: var(--accent-hover);
        }

        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .remember-me {
            margin-top: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .remember-me input {
            accent-color: var(--accent);
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 9999px;
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .filter-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .filter-btn .count {
            background: rgba(255,255,255,0.2);
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            margin-left: 0.5rem;
            font-size: 0.75rem;
        }

        /* Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Controls Row */
        .controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .controls-right {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .year-select {
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
        }

        .year-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .view-toggle {
            display: flex;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 0.25rem;
            gap: 0.25rem;
        }

        .view-btn {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .view-btn:hover {
            color: var(--text-primary);
        }

        .view-btn.active {
            background: var(--accent);
            color: white;
        }

        /* Leagues Grid */
        .leagues-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 1rem;
        }

        .leagues-grid.compact {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .leagues-grid.compact .league-card {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
        }

        .leagues-grid.compact .league-header {
            border-bottom: none;
        }

        .leagues-grid.compact .roster-section,
        .leagues-grid.compact .picks-section {
            display: none;
        }

        .league-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--border);
            transition: border-color 0.2s, transform 0.2s;
        }

        .league-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .league-header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .league-avatar {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
            overflow: hidden;
        }

        .league-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .league-info {
            flex: 1;
            min-width: 0;
        }

        .league-name {
            font-weight: 700;
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .league-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            margin-top: 0.375rem;
        }

        .league-badge {
            font-size: 0.65rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-dynasty { background: rgba(139, 92, 246, 0.2); color: var(--dynasty); }
        .badge-redraft { background: rgba(16, 185, 129, 0.2); color: var(--redraft); }
        .badge-keeper { background: rgba(245, 158, 11, 0.2); color: var(--keeper); }
        .badge-setting { background: rgba(29, 155, 240, 0.15); color: var(--accent); }

        .league-record {
            text-align: right;
            flex-shrink: 0;
        }

        .record-value {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .record-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        /* Roster Section */
        .roster-section {
            padding: 0.75rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .roster-section::-webkit-scrollbar {
            width: 6px;
        }

        .roster-section::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        .roster-section::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .position-group {
            margin-bottom: 0.75rem;
        }

        .position-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.5rem;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-secondary);
            letter-spacing: 0.5px;
        }

        .position-count {
            background: var(--bg-card);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-size: 0.65rem;
        }

        .players-list {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .player-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-card);
            border-radius: 8px;
            font-size: 0.85rem;
            transition: background 0.2s;
        }

        .player-row:hover {
            background: var(--bg-hover);
        }

        .player-pos {
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            min-width: 28px;
            text-align: center;
        }

        .pos-qb { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .pos-rb { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .pos-wr { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .pos-te { background: rgba(249, 115, 22, 0.2); color: #f97316; }
        .pos-k { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
        .pos-def { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }
        .pos-dl { background: rgba(236, 72, 153, 0.2); color: #ec4899; }
        .pos-lb { background: rgba(20, 184, 166, 0.2); color: #14b8a6; }
        .pos-db { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }

        .player-name {
            flex: 1;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-team {
            font-size: 0.7rem;
            color: var(--text-secondary);
            background: var(--bg-primary);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
        }

        .player-status {
            font-size: 0.65rem;
            padding: 0.15rem 0.35rem;
            border-radius: 4px;
        }

        .status-ir { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .status-taxi { background: rgba(139, 92, 246, 0.2); color: var(--dynasty); }

        /* Draft Picks */
        .picks-section {
            padding: 0.75rem;
            border-top: 1px solid var(--border);
            background: var(--bg-card);
        }

        .picks-title {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .picks-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
        }

        .pick-badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            background: var(--bg-secondary);
            border-radius: 4px;
            color: var(--text-secondary);
        }

        .pick-badge.own {
            background: rgba(0, 186, 124, 0.2);
            color: var(--success);
        }

        .pick-badge.extra {
            background: rgba(29, 155, 240, 0.2);
            color: var(--accent);
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem;
            color: var(--text-secondary);
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error */
        .error-message {
            background: rgba(244, 33, 46, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
            margin: 1rem 0;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .footer a {
            color: var(--accent);
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 1rem;
            }

            .search-form {
                flex-direction: column;
            }

            .leagues-grid {
                grid-template-columns: 1fr;
            }

            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }

            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }

            .controls-right {
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="app"></div>
    </div>

    <script>
        // ============================================
        // DYNASTY DASHBOARD - SLEEPER API CLIENT
        // ============================================

        const SLEEPER_API = 'https://api.sleeper.app/v1';
        const STORAGE_KEY = 'dynasty_dashboard_user';
        
        let allPlayers = {};
        let currentUser = null;
        let allLeagues = [];
        let currentFilter = 'all';
        let currentView = 'cards';
        let currentYear = '2025';

        const positionOrder = ['QB', 'RB', 'WR', 'TE', 'K', 'DEF', 'DL', 'LB', 'DB'];

        // ============================================
        // INITIALIZATION
        // ============================================

        async function init() {
            // Check for saved user
            const savedUser = localStorage.getItem(STORAGE_KEY);
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    await loadUserLeagues();
                    return;
                } catch (e) {
                    localStorage.removeItem(STORAGE_KEY);
                }
            }
            renderSearchScreen();
        }

        // ============================================
        // SEARCH SCREEN
        // ============================================

        function renderSearchScreen() {
            document.getElementById('app').innerHTML = `
                <header>
                    <h1>üèà Dynasty Dashboard</h1>
                </header>
                <div class="search-section">
                    <div class="search-logo">üèà</div>
                    <div class="search-title">Dynasty Dashboard</div>
                    <div class="search-subtitle">Visualize todas suas ligas Sleeper em um s√≥ lugar</div>
                    <div class="search-form">
                        <input type="text" class="search-input" id="usernameInput" placeholder="Username do Sleeper" autocomplete="off">
                        <button type="button" class="search-btn" id="searchBtn" onclick="handleSearch()">Carregar</button>
                    </div>
                    <label class="remember-me">
                        <input type="checkbox" id="rememberMe" checked>
                        Lembrar de mim neste dispositivo
                    </label>
                </div>
                <div class="footer">
                    Dados via <a href="https://docs.sleeper.com/" target="_blank">Sleeper API</a>
                </div>
            `;
            
            document.getElementById('usernameInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleSearch();
            });
            
            document.getElementById('usernameInput').focus();
        }

        async function handleSearch() {
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) return;

            const btn = document.getElementById('searchBtn');
            btn.disabled = true;
            btn.textContent = 'Carregando...';

            try {
                // Fetch user
                showLoading('Buscando usu√°rio...');
                const userRes = await fetch(`${SLEEPER_API}/user/${username}`);
                
                if (!userRes.ok) {
                    throw new Error('Usu√°rio n√£o encontrado');
                }
                
                currentUser = await userRes.json();
                
                // Save if remember me is checked
                if (document.getElementById('rememberMe')?.checked) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(currentUser));
                }
                
                await loadUserLeagues();
                
            } catch (error) {
                renderSearchScreen();
                showError(error.message);
            }
        }

        async function loadUserLeagues() {
            showLoading('Carregando jogadores NFL...');
            
            // Load players database (cached in memory)
            if (Object.keys(allPlayers).length === 0) {
                try {
                    const playersRes = await fetch(`${SLEEPER_API}/players/nfl`);
                    allPlayers = await playersRes.json();
                } catch (e) {
                    console.error('Failed to load players:', e);
                }
            }

            showLoading('Carregando ligas...');

            // Try multiple seasons
            const seasons = ['2025', '2024', '2023'];
            allLeagues = [];
            
            for (const season of seasons) {
                try {
                    const leaguesRes = await fetch(`${SLEEPER_API}/user/${currentUser.user_id}/leagues/nfl/${season}`);
                    const leagues = await leaguesRes.json();
                    
                    if (leagues && leagues.length > 0) {
                        currentYear = season;
                        allLeagues = leagues;
                        break;
                    }
                } catch (e) {
                    console.error(`Failed to load ${season} leagues:`, e);
                }
            }

            if (allLeagues.length === 0) {
                renderSearchScreen();
                showError('Nenhuma liga encontrada');
                return;
            }

            showLoading(`Carregando rosters (${allLeagues.length} ligas)...`);

            // Load rosters for each league (in parallel batches)
            const batchSize = 5;
            for (let i = 0; i < allLeagues.length; i += batchSize) {
                const batch = allLeagues.slice(i, i + batchSize);
                await Promise.all(batch.map(loadLeagueDetails));
            }

            renderDashboard();
        }

        async function loadLeagueDetails(league) {
            try {
                const [rostersRes, usersRes] = await Promise.all([
                    fetch(`${SLEEPER_API}/league/${league.league_id}/rosters`),
                    fetch(`${SLEEPER_API}/league/${league.league_id}/users`)
                ]);

                league.rosters = await rostersRes.json();
                league.users = await usersRes.json();
                league.myRoster = league.rosters.find(r => r.owner_id === currentUser.user_id);

                // Load traded picks for dynasty leagues
                if (getLeagueType(league) === 'dynasty') {
                    try {
                        const tradedRes = await fetch(`${SLEEPER_API}/league/${league.league_id}/traded_picks`);
                        league.tradedPicks = await tradedRes.json();
                    } catch (e) {
                        league.tradedPicks = [];
                    }
                }
            } catch (e) {
                console.error(`Error loading league ${league.name}:`, e);
            }
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function showLoading(message) {
            document.getElementById('app').innerHTML = `
                <header>
                    <h1>üèà Dynasty Dashboard</h1>
                </header>
                <div class="loading">
                    <div class="spinner"></div>
                    <div>${message}</div>
                </div>
            `;
        }

        function showError(message) {
            const existing = document.querySelector('.error-message');
            if (existing) existing.remove();

            const error = document.createElement('div');
            error.className = 'error-message';
            error.textContent = message;
            document.querySelector('.search-section')?.appendChild(error);
        }

        function logout() {
            localStorage.removeItem(STORAGE_KEY);
            currentUser = null;
            allLeagues = [];
            renderSearchScreen();
        }

        function getLeagueType(league) {
            if (league.settings?.type === 2) return 'dynasty';
            if (league.settings?.type === 1) return 'keeper';
            return 'redraft';
        }

        function getLeagueSettings(league) {
            const settings = [];
            const s = league.scoring_settings || {};

            if (s.rec === 1) settings.push('PPR');
            else if (s.rec === 0.5) settings.push('Half');
            else if (s.rec === 0) settings.push('Std');

            if (s.bonus_rec_te && s.bonus_rec_te > 0) {
                settings.push(`TEP`);
            }

            const rosterPositions = league.roster_positions || [];
            if (rosterPositions.includes('SUPER_FLEX')) {
                settings.push('SF');
            }

            if (rosterPositions.some(p => ['DL', 'LB', 'DB', 'IDP_FLEX'].includes(p))) {
                settings.push('IDP');
            }

            settings.push(`${league.total_rosters}T`);

            return settings;
        }

        function getFilteredLeagues() {
            if (currentFilter === 'all') return allLeagues;
            return allLeagues.filter(l => getLeagueType(l) === currentFilter);
        }

        function getStats() {
            const filtered = getFilteredLeagues();
            let totalWins = 0, totalLosses = 0, totalTies = 0;
            
            filtered.forEach(l => {
                if (l.myRoster?.settings) {
                    totalWins += l.myRoster.settings.wins || 0;
                    totalLosses += l.myRoster.settings.losses || 0;
                    totalTies += l.myRoster.settings.ties || 0;
                }
            });

            const dynastyCount = allLeagues.filter(l => getLeagueType(l) === 'dynasty').length;
            const redraftCount = allLeagues.filter(l => getLeagueType(l) === 'redraft').length;
            const keeperCount = allLeagues.filter(l => getLeagueType(l) === 'keeper').length;

            return {
                total: filtered.length,
                dynasty: dynastyCount,
                redraft: redraftCount,
                keeper: keeperCount,
                wins: totalWins,
                losses: totalLosses,
                ties: totalTies,
                winPct: totalWins + totalLosses > 0 
                    ? ((totalWins / (totalWins + totalLosses)) * 100).toFixed(1) 
                    : 0
            };
        }

        // ============================================
        // DASHBOARD RENDERING
        // ============================================

        function renderDashboard() {
            const stats = getStats();
            const leagues = getFilteredLeagues();

            document.getElementById('app').innerHTML = `
                <header>
                    <h1>üèà Dynasty Dashboard</h1>
                    <div class="header-right">
                        <div class="user-info">
                            ${currentUser.avatar 
                                ? `<img src="https://sleepercdn.com/avatars/thumbs/${currentUser.avatar}" class="user-avatar">`
                                : `<div class="user-avatar"></div>`
                            }
                            <span class="user-name">${currentUser.display_name || currentUser.username}</span>
                        </div>
                        <button class="logout-btn" onclick="logout()">Sair</button>
                    </div>
                </header>

                <div class="stats-bar">
                    <div class="stat-card">
                        <div class="stat-value">${stats.total}</div>
                        <div class="stat-label">Ligas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.dynasty}</div>
                        <div class="stat-label">Dynasty</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.wins}-${stats.losses}${stats.ties > 0 ? `-${stats.ties}` : ''}</div>
                        <div class="stat-label">Record Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.winPct}%</div>
                        <div class="stat-label">Win Rate</div>
                    </div>
                </div>

                <div class="controls-row">
                    <div class="filters">
                        <button class="filter-btn ${currentFilter === 'all' ? 'active' : ''}" onclick="setFilter('all')">
                            Todas <span class="count">${allLeagues.length}</span>
                        </button>
                        <button class="filter-btn ${currentFilter === 'dynasty' ? 'active' : ''}" onclick="setFilter('dynasty')">
                            Dynasty <span class="count">${stats.dynasty}</span>
                        </button>
                        ${stats.redraft > 0 ? `
                        <button class="filter-btn ${currentFilter === 'redraft' ? 'active' : ''}" onclick="setFilter('redraft')">
                            Redraft <span class="count">${stats.redraft}</span>
                        </button>
                        ` : ''}
                        ${stats.keeper > 0 ? `
                        <button class="filter-btn ${currentFilter === 'keeper' ? 'active' : ''}" onclick="setFilter('keeper')">
                            Keeper <span class="count">${stats.keeper}</span>
                        </button>
                        ` : ''}
                    </div>
                    <div class="controls-right">
                        <select class="year-select" onchange="changeYear(this.value)">
                            <option value="2025" ${currentYear === '2025' ? 'selected' : ''}>2025</option>
                            <option value="2024" ${currentYear === '2024' ? 'selected' : ''}>2024</option>
                            <option value="2023" ${currentYear === '2023' ? 'selected' : ''}>2023</option>
                        </select>
                        <div class="view-toggle">
                            <button class="view-btn ${currentView === 'cards' ? 'active' : ''}" onclick="setView('cards')">Cards</button>
                            <button class="view-btn ${currentView === 'compact' ? 'active' : ''}" onclick="setView('compact')">Lista</button>
                        </div>
                    </div>
                </div>

                <div class="leagues-grid ${currentView}">
                    ${leagues.map(league => renderLeagueCard(league)).join('')}
                </div>

                <div class="footer">
                    Dados via <a href="https://docs.sleeper.com/" target="_blank">Sleeper API</a> ‚Ä¢ 
                    Temporada ${currentYear}
                </div>
            `;
        }

        function renderLeagueCard(league) {
            const type = getLeagueType(league);
            const settings = getLeagueSettings(league);
            const roster = league.myRoster;
            
            const record = roster?.settings 
                ? `${roster.settings.wins || 0}-${roster.settings.losses || 0}${roster.settings.ties ? `-${roster.settings.ties}` : ''}`
                : '-';
            
            const fpts = roster?.settings?.fpts 
                ? (roster.settings.fpts + (roster.settings.fpts_decimal || 0) / 100).toFixed(1)
                : null;

            // Group players by position
            const playersByPosition = {};
            const rosterPlayers = roster?.players || [];
            const taxiPlayers = roster?.taxi || [];
            const irPlayers = roster?.reserve || [];

            rosterPlayers.forEach(playerId => {
                const player = allPlayers[playerId];
                if (player) {
                    const pos = player.position || 'UNKNOWN';
                    if (!playersByPosition[pos]) playersByPosition[pos] = [];
                    playersByPosition[pos].push({
                        ...player,
                        playerId,
                        status: irPlayers.includes(playerId) ? 'IR' : 
                               taxiPlayers.includes(playerId) ? 'TAXI' : null
                    });
                }
            });

            // Add taxi players that might not be in main roster
            taxiPlayers.forEach(playerId => {
                if (!rosterPlayers.includes(playerId)) {
                    const player = allPlayers[playerId];
                    if (player) {
                        const pos = player.position || 'UNKNOWN';
                        if (!playersByPosition[pos]) playersByPosition[pos] = [];
                        playersByPosition[pos].push({
                            ...player,
                            playerId,
                            status: 'TAXI'
                        });
                    }
                }
            });

            const sortedPositions = Object.keys(playersByPosition).sort(
                (a, b) => positionOrder.indexOf(a) - positionOrder.indexOf(b)
            );

            // Get draft picks for dynasty
            let picksHtml = '';
            if (type === 'dynasty') {
                const myPicks = getMyDraftPicks(league);
                if (myPicks.length > 0) {
                    picksHtml = `
                        <div class="picks-section">
                            <div class="picks-title">Draft Picks</div>
                            <div class="picks-grid">
                                ${myPicks.map(p => `
                                    <span class="pick-badge ${p.isOwn ? 'own' : 'extra'}" title="${p.note || ''}">${p.label}</span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            }

            return `
                <div class="league-card">
                    <div class="league-header">
                        <div class="league-avatar">
                            ${league.avatar 
                                ? `<img src="https://sleepercdn.com/avatars/thumbs/${league.avatar}" alt="">`
                                : 'üèà'
                            }
                        </div>
                        <div class="league-info">
                            <div class="league-name" title="${league.name}">${league.name}</div>
                            <div class="league-meta">
                                <span class="league-badge badge-${type}">${type}</span>
                                ${settings.map(s => `<span class="league-badge badge-setting">${s}</span>`).join('')}
                            </div>
                        </div>
                        <div class="league-record">
                            <div class="record-value">${record}</div>
                            ${fpts ? `<div class="record-label">${fpts} pts</div>` : ''}
                        </div>
                    </div>
                    <div class="roster-section">
                        ${sortedPositions.map(pos => `
                            <div class="position-group">
                                <div class="position-header">
                                    ${pos}
                                    <span class="position-count">${playersByPosition[pos].length}</span>
                                </div>
                                <div class="players-list">
                                    ${playersByPosition[pos]
                                        .sort((a, b) => (a.search_rank || 9999) - (b.search_rank || 9999))
                                        .map(player => `
                                            <div class="player-row">
                                                <span class="player-pos pos-${pos.toLowerCase()}">${pos}</span>
                                                <span class="player-name">${player.full_name || `${player.first_name} ${player.last_name}`}</span>
                                                <span class="player-team">${player.team || 'FA'}</span>
                                                ${player.status ? `<span class="player-status status-${player.status.toLowerCase()}">${player.status}</span>` : ''}
                                            </div>
                                        `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ${picksHtml}
                </div>
            `;
        }

        function getMyDraftPicks(league) {
            const picks = [];
            const tradedPicks = league.tradedPicks || [];
            const myRosterId = league.myRoster?.roster_id;
            if (!myRosterId) return picks;

            const currentSeason = parseInt(league.season);
            
            for (let year = currentSeason + 1; year <= currentSeason + 3; year++) {
                for (let round = 1; round <= 5; round++) {
                    // Check if I still own my own pick
                    const myPickTraded = tradedPicks.find(
                        t => t.season === String(year) && 
                             t.round === round && 
                             t.roster_id === myRosterId && 
                             t.owner_id !== myRosterId
                    );

                    if (!myPickTraded) {
                        picks.push({
                            label: `'${String(year).slice(-2)} R${round}`,
                            isOwn: true,
                            note: 'Sua pick'
                        });
                    }

                    // Check if I acquired someone else's pick
                    const acquiredPicks = tradedPicks.filter(
                        t => t.season === String(year) && 
                             t.round === round && 
                             t.owner_id === myRosterId &&
                             t.roster_id !== myRosterId
                    );

                    acquiredPicks.forEach(trade => {
                        const originalOwner = league.rosters?.find(r => r.roster_id === trade.roster_id);
                        const ownerUser = league.users?.find(u => u.user_id === originalOwner?.owner_id);
                        picks.push({
                            label: `'${String(year).slice(-2)} R${round}`,
                            isOwn: false,
                            note: ownerUser?.display_name || 'Adquirida'
                        });
                    });
                }
            }

            return picks.sort((a, b) => {
                const [aYear, aRound] = a.label.match(/\d+/g);
                const [bYear, bRound] = b.label.match(/\d+/g);
                return aYear - bYear || aRound - bRound;
            });
        }

        // ============================================
        // EVENT HANDLERS
        // ============================================

        function setFilter(filter) {
            currentFilter = filter;
            renderDashboard();
        }

        function setView(view) {
            currentView = view;
            renderDashboard();
        }

        async function changeYear(year) {
            currentYear = year;
            showLoading(`Carregando ligas ${year}...`);
            
            try {
                const leaguesRes = await fetch(`${SLEEPER_API}/user/${currentUser.user_id}/leagues/nfl/${year}`);
                allLeagues = await leaguesRes.json() || [];

                if (allLeagues.length > 0) {
                    showLoading(`Carregando rosters...`);
                    const batchSize = 5;
                    for (let i = 0; i < allLeagues.length; i += batchSize) {
                        const batch = allLeagues.slice(i, i + batchSize);
                        await Promise.all(batch.map(loadLeagueDetails));
                    }
                }

                renderDashboard();
            } catch (error) {
                console.error('Error changing year:', error);
                renderDashboard();
            }
        }

        // ============================================
        // START APP
        // ============================================

        init();
    </script>
</body>
</html>
